<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.33">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/img/logo.png"><link rel="manifest" href="/manifest.json"><script async>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?36884888f7a05e80a42de77a45873e51";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s)})();</script><title>AQS源码解析 | stormbuf's blog</title><meta name="description" content="stormbuf 的博客">
    <link rel="modulepreload" href="/assets/app.edc637f8.js"><link rel="modulepreload" href="/assets/AQS_source_code_parse.html.b6d5d5f7.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/AQS_source_code_parse.html.85f86c99.js">
    <link rel="stylesheet" href="/assets/style.924ef254.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">stormbuf&#39;s blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="home"><!--[--><!--]--> home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="program"><span class="title">program</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="program"><span class="title">program</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/program/java/" class="router-link-active" aria-label="java"><!--[--><!--]--> java <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/program/golang/" class="" aria-label="golang"><!--[--><!--]--> golang <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/program/distributed/" class="" aria-label="分布式"><!--[--><!--]--> 分布式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/program/frontEnd/" class="" aria-label="front-end"><!--[--><!--]--> front-end <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/db/" class="" aria-label="database"><!--[--><!--]--> database <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/weekly/" class="" aria-label="weekly"><!--[--><!--]--> weekly <!--[--><!--]--></a></div><div class="navbar-item"><a href="/archivesPage/" class="" aria-label="timeline"><!--[--><!--]--> timeline <!--[--><!--]--></a></div><div class="navbar-item"><a href="/friends/" class="" aria-label="friends"><!--[--><!--]--> friends <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://stormbuf.top/rss.xml" target="_self" aria-label="RSS"><!--[--><!--]--> RSS <!----><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="home"><!--[--><!--]--> home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="program"><span class="title">program</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="program"><span class="title">program</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/program/java/" class="router-link-active" aria-label="java"><!--[--><!--]--> java <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/program/golang/" class="" aria-label="golang"><!--[--><!--]--> golang <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/program/distributed/" class="" aria-label="分布式"><!--[--><!--]--> 分布式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/program/frontEnd/" class="" aria-label="front-end"><!--[--><!--]--> front-end <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/db/" class="" aria-label="database"><!--[--><!--]--> database <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/weekly/" class="" aria-label="weekly"><!--[--><!--]--> weekly <!--[--><!--]--></a></div><div class="navbar-item"><a href="/archivesPage/" class="" aria-label="timeline"><!--[--><!--]--> timeline <!--[--><!--]--></a></div><div class="navbar-item"><a href="/friends/" class="" aria-label="friends"><!--[--><!--]--> friends <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://stormbuf.top/rss.xml" target="_self" aria-label="RSS"><!--[--><!--]--> RSS <!----><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p class="sidebar-item sidebar-heading">AQS源码解析 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/program/java/AQS_source_code_parse.html#介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/program/java/AQS_source_code_parse.html#应用实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="应用实例"><!--[--><!--]--> 应用实例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/program/java/AQS_source_code_parse.html#主要组成" class="router-link-active router-link-exact-active sidebar-item" aria-label="主要组成"><!--[--><!--]--> 主要组成 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/program/java/AQS_source_code_parse.html#整体框架" class="router-link-active router-link-exact-active sidebar-item" aria-label="整体框架"><!--[--><!--]--> 整体框架 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="aqs源码解析" tabindex="-1"><a class="header-anchor" href="#aqs源码解析" aria-hidden="true">#</a> AQS源码解析</h1><h2 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h2><p>AQS 的全称为（AbstractQueuedSynchronizer），一个抽象类。AQS 是一个用来构建锁和同步器的框架，通过 AQS 能高效的构造出同步器。</p><p>作为用于构建锁和同步器的框架，AQS 为此提供了线程阻塞/唤醒、线程排队、获取资源失败处理等一系列公用的复杂实现，而使用者仅需要定义如何获取资源和如何释放资源的这些简单的操作。（设计模式——模板方法的应用）</p><p>AQS 的实现思路：当线程请求资源时，若资源空闲，则锁定资源，并将线程设为工作线程；若资源被占用，则将线程放入等待队列，后续排队获取资源，并为此提供了线程阻塞/唤醒和被唤醒线程锁分配的机制。</p><p>AQS 提供了两种同步方式：</p><ul><li>共享式</li><li>独占式</li></ul><p>使用 AQS 方式一般是根据选择的同步方式，重写以下部分或全部方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="shiki" style="background-color:#0d1117;"><code><span class="line"><span style="color:#8B949E;">//独占式尝试获取独占资源</span></span>
<span class="line"><span style="color:#FF7B72;">protected</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">boolean</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">tryAcquire</span><span style="color:#C9D1D9;">(</span><span style="color:#FF7B72;">int</span><span style="color:#C9D1D9;"> arg);</span></span>
<span class="line"><span style="color:#8B949E;">//独占式尝试释放独占资源</span></span>
<span class="line"><span style="color:#FF7B72;">protected</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">boolean</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">tryRelease</span><span style="color:#C9D1D9;">(</span><span style="color:#FF7B72;">int</span><span style="color:#C9D1D9;"> arg);</span></span>
<span class="line"><span style="color:#8B949E;">//共享式尝试获取共享资源</span></span>
<span class="line"><span style="color:#FF7B72;">protected</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">int</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">tryAcquireShared</span><span style="color:#C9D1D9;">(</span><span style="color:#FF7B72;">int</span><span style="color:#C9D1D9;"> arg);</span></span>
<span class="line"><span style="color:#8B949E;">//共享式尝试释放共享资源</span></span>
<span class="line"><span style="color:#FF7B72;">protected</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">boolean</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">tryReleaseShared</span><span style="color:#C9D1D9;">(</span><span style="color:#FF7B72;">int</span><span style="color:#C9D1D9;"> arg);</span></span>
<span class="line"><span style="color:#8B949E;">//资源是否被当前线程独占</span></span>
<span class="line"><span style="color:#FF7B72;">protected</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">boolean</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">isHeldExclusively</span><span style="color:#C9D1D9;">();</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://raw.githubusercontent.com/stormbuf/blog/main/img/20210723121905.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/stormbuf/blog/main/img/20210723121938.png" alt="img"></p><h2 id="应用实例" tabindex="-1"><a class="header-anchor" href="#应用实例" aria-hidden="true">#</a> 应用实例</h2><p>JDK 中的应用：</p><ul><li>ReentrantLock</li><li>ReentrantReadWriteLock</li><li>Semaphore</li><li>CountDownLatch</li></ul><h2 id="主要组成" tabindex="-1"><a class="header-anchor" href="#主要组成" aria-hidden="true">#</a> 主要组成</h2><p><img src="https://raw.githubusercontent.com/stormbuf/blog/main/img/CLH.png" alt="img"></p><p><strong>state</strong></p><p>AQS 中的资源，一般称为同步状态。</p><p><strong>CLH</strong></p><p>CLH队列，是一个链表实现的双向队列，用以作为 AQS 中的等待队列。队列中的结点是 AQS 的内部类 <code>Node</code> ，一个节点表示一个线程。</p><p><strong>ConditionObject</strong></p><p>用于实现条件队列。</p><h2 id="整体框架" tabindex="-1"><a class="header-anchor" href="#整体框架" aria-hidden="true">#</a> 整体框架</h2><p><img src="https://raw.githubusercontent.com/stormbuf/blog/main/img/20210723120337.png" alt="img"></p><h1 id="node-waitstatus" tabindex="-1"><a class="header-anchor" href="#node-waitstatus" aria-hidden="true">#</a> Node waitStatus</h1><table><thead><tr><th>枚举</th><th>含义</th></tr></thead><tbody><tr><td>0</td><td>当一个Node被初始化的时候的默认值</td></tr><tr><td>CANCELLED</td><td>为1，表示线程获取锁的请求已经取消了</td></tr><tr><td>CONDITION</td><td>为-2，表示节点在等待队列中，节点线程等待唤醒</td></tr><tr><td>PROPAGATE</td><td>为-3，当前线程处在SHARED情况下，该字段才会使用</td></tr><tr><td>SIGNAL</td><td>为-1，表示线程已经准备好了，就等资源释放了</td></tr></tbody></table><h1 id="应用场景" tabindex="-1"><a class="header-anchor" href="#应用场景" aria-hidden="true">#</a> 应用场景</h1><table><thead><tr><th>同步工具</th><th>同步工具与AQS的关联</th></tr></thead><tbody><tr><td>ReentrantLock</td><td>使用AQS保存锁重复持有的次数。当一个线程获取锁时，ReentrantLock记录当前获得锁的线程标识，用于检测是否重复获取，以及错误线程试图解锁操作时异常情况的处理。</td></tr><tr><td>Semaphore</td><td>使用AQS同步状态来保存信号量的当前计数。tryRelease会增加计数，acquireShared会减少计数。</td></tr><tr><td>CountDownLatch</td><td>使用AQS同步状态来表示计数。计数为0时，所有的Acquire操作（CountDownLatch的await方法）才可以通过。</td></tr><tr><td>ReentrantReadWriteLock</td><td>使用AQS同步状态中的16位保存写锁持有的次数，剩下的16位用于保存读锁的持有次数。</td></tr><tr><td>ThreadPoolExecutor</td><td>Worker利用AQS同步状态实现对独占线程变量的设置（tryAcquire和tryRelease）。</td></tr></tbody></table><h1 id="条件队列condition" tabindex="-1"><a class="header-anchor" href="#条件队列condition" aria-hidden="true">#</a> 条件队列Condition</h1><p><img src="http://img.stormbuf.top/20210723151704.png" alt="img"></p><div class="language-java ext-java line-numbers-mode"><pre class="shiki" style="background-color:#0d1117;"><code><span class="line"><span style="color:#8B949E;">// ========== 阻塞 ==========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// 造成当前线程在接到信号或被中断之前一直处于等待状态,调用的时候会将当前node释放锁或从CLH队列中移除。</span></span>
<span class="line"><span style="color:#FF7B72;">void</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">await</span><span style="color:#C9D1D9;">() throws InterruptedException; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// 造成当前线程在接到信号之前一直处于等待状态。【注意：该方法对中断不敏感】。</span></span>
<span class="line"><span style="color:#FF7B72;">void</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">awaitUninterruptibly</span><span style="color:#C9D1D9;">(); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// 造成当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态。</span></span>
<span class="line"><span style="color:#8B949E;">// 返回值表示剩余时间，如果在`nanosTimeout` 之前唤醒，那么返回值 `= nanosTimeout - 消耗时间` ，如果返回值 `&lt;= 0` ,则可以认定它已经超时了。</span></span>
<span class="line"><span style="color:#FF7B72;">long</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">awaitNanos</span><span style="color:#C9D1D9;">(</span><span style="color:#FF7B72;">long</span><span style="color:#C9D1D9;"> nanosTimeout) throws InterruptedException; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// 造成当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态。</span></span>
<span class="line"><span style="color:#8B949E;">// 如果没有到指定时间就被通知，则返回 true ，否则表示到了指定时间，返回返回 false 。</span></span>
<span class="line"><span style="color:#FF7B72;">boolean</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">await</span><span style="color:#C9D1D9;">(</span><span style="color:#FF7B72;">long</span><span style="color:#C9D1D9;"> time, TimeUnit unit) throws InterruptedException; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// 造成当前线程在接到信号、被中断或到达指定最后期限之前一直处于等待状态。</span></span>
<span class="line"><span style="color:#8B949E;">// 如果没有到指定时间就被通知，则返回 true ，否则表示到了指定时间，返回返回 false 。</span></span>
<span class="line"><span style="color:#FF7B72;">boolean</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">awaitUntil</span><span style="color:#C9D1D9;">(Date deadline) throws InterruptedException; </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// ========== 唤醒 ==========</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// 唤醒一个等待线程。该线程从等待方法返回前必须获得与Condition相关的锁。</span></span>
<span class="line"><span style="color:#FF7B72;">void</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">signal</span><span style="color:#C9D1D9;">(); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8B949E;">// 唤醒所有等待线程。能够从等待方法返回的线程必须获得与Condition相关的锁。</span></span>
<span class="line"><span style="color:#FF7B72;">void</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">signalAll</span><span style="color:#C9D1D9;">(); </span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.edc637f8.js" defer></script>
  </body>
</html>
